# Troubleshooting Guide

## FFmpeg エラー診断ガイド

### エラー: "ffmpeg exited with code 1: Conversion failed!"

このエラーが発生した場合、以下の手順で原因を特定してください。

---

## ステップ1: 動画ファイルの診断

診断スクリプトを実行して、入力動画ファイルの状態を確認します。

### 使い方

```bash
node test-ffmpeg.js "動画ファイルのパス"
```

### 例

```bash
node test-ffmpeg.js "C:\Users\asd95\Videos\video1.mp4"
node test-ffmpeg.js "C:\Users\asd95\Videos\ScreenRecording_12-05-2024.mov"
```

### 診断内容

このスクリプトは以下を確認します：

1. **ファイルの存在確認**
   - ファイルが存在するか
   - ファイルサイズ

2. **動画メタデータの確認**
   - 動画の長さ
   - 動画形式
   - ビットレート
   - ストリーム情報（映像・音声）

3. **音声トラックの確認**
   - 音声トラックが存在するか
   - サンプルレート、チャンネル数

4. **音声抽出テスト**
   - 実際に音声抽出が可能か
   - FFmpegコマンドとエラー出力を表示

---

## よくある問題と解決方法

### 問題1: 音声トラックがない

**症状:**
```
Has audio track: NO
WARNING: This video does not have an audio track!
```

**原因:**
動画ファイルに音声トラックが含まれていません。

**解決方法:**
1. 動画を再エクスポートして音声を含める
2. 音声トラックのある動画ファイルを使用する
3. 動画編集ソフトで音声トラックを追加する

---

### 問題2: ファイルパスに日本語や特殊文字が含まれている

**症状:**
```
ERROR: File does not exist
```

**原因:**
Windowsのパス処理で日本語や特殊文字が正しく扱えない場合があります。

**解決方法:**
1. ファイルを英数字のみのパスに移動する
   - 例: `C:\Videos\video1.mp4`
2. ファイル名を英数字に変更する
   - 例: `video_20241205.mp4`

---

### 問題3: 動画形式がサポートされていない

**症状:**
```
ERROR: ffprobe failed
```

**原因:**
動画のコーデックがFFmpegでサポートされていない可能性があります。

**解決方法:**
1. 動画を一般的な形式に変換する（MP4, H.264コーデック推奨）
2. HandBrakeやFFmpegで動画を再エンコードする

---

### 問題4: ファイルが破損している

**症状:**
```
ERROR: Audio extraction failed
Invalid data found when processing input
```

**原因:**
動画ファイルが破損しているか、不完全です。

**解決方法:**
1. 動画を再度ダウンロード/エクスポートする
2. 動画編集ソフトで開いて再保存する
3. FFmpegで再エンコードする:
   ```bash
   ffmpeg -i input.mp4 -c:v libx264 -c:a aac output.mp4
   ```

---

## ステップ2: アプリケーションの詳細エラー確認

アプリケーション内で処理を実行すると、エラーメッセージが表示されます。

### 改善されたエラー表示

最新版では、以下の詳細情報が表示されます：

1. **FFmpegのエラー出力（stderr）**
   - FFmpegが出力した詳細なエラーメッセージ
   - コマンドライン引数

2. **どのステップでエラーが発生したか**
   - ステップ2: 音声同期
   - ステップ4: 音声抽出
   - など

3. **具体的なエラーの原因**
   - 音声トラックがない
   - ファイルが見つからない
   - タイムアウト

---

## ステップ3: 推奨する動画の仕様

### 動画A（縦動画）

- **形式**: MP4 (H.264)
- **解像度**: 1080x1920 または 720x1280
- **フレームレート**: 30fps または 60fps
- **音声**: AAC, 48kHz, ステレオ
- **ビットレート**: 5-10 Mbps

### 動画B（画面録画）

- **ファイル名**: "ScreenRecording"を含む
- **形式**: MOV または MP4 (H.264)
- **音声**: AAC, 48kHz, ステレオまたはモノラル
- **ビットレート**: 5-10 Mbps

### 参照JPEG

- **形式**: JPEG (.jpg または .jpeg)
- **解像度**: 1920x1080以上推奨
- **色空間**: RGB

---

## ステップ4: サポートが必要な場合

以下の情報を準備してください：

1. **診断スクリプトの出力結果**
   ```bash
   node test-ffmpeg.js "動画パス" > diagnostic.txt
   ```

2. **アプリケーションのエラーメッセージ全文**
   - UIに表示されたエラーメッセージをコピー

3. **動画ファイルの情報**
   - ファイルサイズ
   - どのソフトで作成したか
   - オリジナルの形式

4. **環境情報**
   - Windows バージョン
   - Node.js バージョン: `node --version`
   - npm バージョン: `npm --version`

---

## よくある質問

### Q: 両方の動画に音声が必要ですか？

A: はい、音声同期機能を使用するため、両方の動画に音声トラックが必要です。

### Q: 動画の長さが異なっても大丈夫ですか？

A: はい、自動的に同期して、重なる部分だけを使用します。

### Q: 60fps変換は必須ですか？

A: いいえ、設定で無効にできます。「60fps変換を有効化」のチェックを外してください。

### Q: 処理にどのくらい時間がかかりますか？

A: 動画の長さと解像度によりますが、5分の動画で10-20分程度かかる場合があります。

---

## 技術的な詳細

### FFmpegコマンド例

アプリケーションが内部で実行しているコマンドの例：

**音声抽出:**
```bash
ffmpeg -i input.mp4 -vn -acodec pcm_s16le -ar 48000 -ac 1 output.wav
```

**動画トリミング:**
```bash
ffmpeg -i input.mp4 -ss 0.5 -t 30.0 -c copy output.mp4
```

**60fps変換:**
```bash
ffmpeg -i input.mp4 -filter:v "minterpolate=fps=60:mi_mode=dup" output.mp4
```

**音声正規化:**
```bash
ffmpeg -i input.mp4 -af "loudnorm=I=-14.0:TP=-1.0" output.mp4
```

---

## まとめ

1. まず `node test-ffmpeg.js` で動画ファイルを診断
2. 音声トラックがあることを確認
3. ファイルパスに日本語がないことを確認
4. エラーメッセージの詳細を確認
5. 必要に応じて動画を再エンコード

これらの手順で問題が解決しない場合は、診断結果とエラーメッセージを添えてお問い合わせください。
